nephrite = require '../'
coco = require 'coco'
fs = require 'fs'

function err
	for @@ => console.log &
	process.exit 1
function read
	fs.readFileSync it, 'utf8' .trim! - /\r/g


console.log 'Booting test suite ...'

cases = fs.readdirSync 'test/jade'
	.map -> it - '.jade'

for cases
	path = "test/jade/#&.jade"
	html-path = path
		.replace '/jade/' '/html/'
		.replace '.jade' '.html'
	json-path = path
		.replace '/jade/' '/json/'
		.replace '.jade' '.json'
	extra-path = json-path.replace '.' '.extra.'
	
	unless fs.existsSync path
		err "cannot find #path"
	unless fs.existsSync html-path
		err "cannot find #html-path"

	args = if fs.existsSync json-path
		try
			JSON.parse read json-path
		catch throw new Error "Cannot parse #json-path"
	else {}
	extra = if fs.existsSync extra-path
		try
			JSON.parse read extra-path
		catch throw new Error "Cannot parse #extra-path"
	else {}

	src = read path .trim!
	html = read html-path

	try
		src = nephrite src, path, {+pretty}
		src = coco.compile src, {+bare}
	catch
		err "Error compiling #path : #e"

	fn = Function "locals" "extra" """
	module = {};
	#src
	return module.exports(locals, extra);
	"""
	try
		result = fn args, extra .trim!
	catch
		console.log """
Error : #e
#src
"""

	if result is html
		console.log "OK: #&."
	else
		err """
**FAIL** : #&.
Got      : #result
Expected : #html
"""

console.log 'Tests finished.'